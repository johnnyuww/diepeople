<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>訃聞名單產生器-手機優化版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --gold: #d4a373; --bg: #1a1a1a; }
        body { font-family: "Microsoft JhengHei", serif; margin: 0; background: #2c3e50; color: #fff; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* 頂部切換與輸入區 - 縮小高度 */
        #input-area { flex: 0 0 45%; background: var(--bg); overflow-y: auto; padding: 10px; border-bottom: 2px solid var(--gold); }
        .mode-bar { display: flex; gap: 8px; margin-bottom: 10px; position: sticky; top: 0; background: var(--bg); z-index: 5; padding-bottom: 5px; }
        .m-btn { flex: 1; padding: 8px; border: none; border-radius: 4px; background: #444; color: white; font-weight: bold; font-size: 14px; }
        .m-btn.active { background: var(--gold); color: #000; }

        .cat { margin-bottom: 12px; background: #252525; padding: 8px; border-radius: 6px; }
        .cat-t { color: var(--gold); font-size: 14px; font-weight: bold; border-bottom: 1px solid #444; margin-bottom: 8px; }
        .i-row { margin-bottom: 6px; display: none; } /* 預設隱藏，由 JS 控制 */
        .i-row.v { display: block; }
        label { display: block; font-size: 11px; color: #888; }
        input { width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #333; background: #000; color: #fff; box-sizing: border-box; font-size: 14px; }

        /* 下方預覽區 - 讓圖片看起來小一點 */
        #preview-area { flex: 1; background: #34495e; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
        #obit-canvas { 
            width: 90%; max-width: 360px; background: white; padding: 30px 20px; color: black; box-sizing: border-box; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); transform: scale(0.9); transform-origin: top center;
        }
        
        /* 訃聞排版樣式 */
        .h1 { text-align: center; font-size: 32px; font-weight: bold; margin-bottom: 15px; letter-spacing: 10px; }
        .name-box { border: 2px solid #000; text-align: center; padding: 8px; font-size: 20px; font-weight: bold; margin-bottom: 20px; }
        .r-row { display: flex; margin-bottom: 6px; border-bottom: 1px solid #eee; padding-bottom: 3px; align-items: flex-start; }
        .r-label { width: 85px; font-weight: bold; font-size: 14px; border-right: 1px solid #000; margin-right: 8px; flex-shrink: 0; }
        .r-names { flex-grow: 1; font-size: 14px; letter-spacing: 1px; word-break: break-all; }

        /* 按鈕區 */
        .f-bar { padding: 10px; background: #1a1a1a; }
        .gen-btn { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; }

        /* 彈出圖片層 */
        #pop-img { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; align-items: center; justify-content: center; 
        }
        #pop-img img { max-width: 90%; max-height: 80%; border: 2px solid white; }
        .pop-t { color: var(--gold); margin-bottom: 10px; font-weight: bold; }
        .close-pop { margin-top: 15px; color: #ccc; text-decoration: underline; }
    </style>
</head>
<body>

<div id="input-area">
    <div class="mode-bar">
        <button class="m-btn active" onclick="chMode('s')">小家庭模式</button>
        <button class="m-btn" onclick="chMode('l')">大家庭 (39欄位)</button>
    </div>

    <div class="cat v">
        <div class="cat-t">亡者姓名</div>
        <input type="text" id="in_main" value="王大明" oninput="up()">
    </div>

    <div id="fields"></div> </div>

<div id="preview-area">
    <div id="obit-canvas">
        <div class="h1">聞</div>
        <div class="name-box" id="out_main">故者：王大明</div>
        <div id="out_list"></div>
    </div>
</div>

<div class="f-bar">
    <button class="gen-btn" onclick="gen()">產生圖片 (長按圖片儲存)</button>
</div>

<div id="pop-img" onclick="this.style.display='none'">
    <div class="pop-t">↓ 已生成！請長按圖片儲存至相簿 ↓</div>
    <img id="res-img" src="">
    <div class="close-pop">點擊任何地方關閉</div>
</div>

<script>
    // 定義所有 39 個欄位 (l:大家庭, s:小家庭)
    const fMap = [
        { id: "c1", l: "未亡人", m: "s" }, { id: "c2", l: "孝　男", m: "s" }, { id: "c3", l: "孝　媳", m: "s" },
        { id: "c4", l: "孝　女", m: "s" }, { id: "c5", l: "孝女婿", m: "s" }, { id: "c6", l: "長　孫", m: "l" },
        { id: "c7", l: "長孫媳", m: "l" }, { id: "c8", l: "孝　孫", m: "s" }, { id: "c9", l: "孝孫錫", m: "l" },
        { id: "c10", l: "孝孫女", m: "s" }, { id: "c11", l: "孝孫婿", m: "l" }, { id: "c12", l: "孝外孫", m: "l" },
        { id: "c13", l: "孝外孫媳", m: "l" }, { id: "c14", l: "孝外孫女", m: "l" }, { id: "c15", l: "孝外孫婿", m: "l" },
        { id: "c16", l: "孝曾孫", m: "l" }, { id: "c17", l: "孝曾孫女", m: "l" }, { id: "c18", l: "孝外曾孫", m: "l" },
        { id: "c19", l: "孝外曾孫女", m: "l" }, { id: "c20", l: "胞　弟", m: "s" }, { id: "c21", l: "胞弟媳", m: "l" },
        { id: "c22", l: "胞　姊", m: "l" }, { id: "c23", l: "胞　妹", m: "l" }, { id: "c24", l: "胞姊夫", m: "l" },
        { id: "c25", l: "胞妹婿", m: "l" }, { id: "c26", l: "胞　姪", m: "l" }, { id: "c27", l: "胞姪媳", m: "l" },
        { id: "c28", l: "胞姪女", m: "l" }, { id: "c29", l: "胞姪婿", m: "l" }, { id: "c30", l: "胞姪孫", m: "l" },
        { id: "c31", l: "胞姪孫女", m: "l" }, { id: "c32", l: "義　子", m: "l" }, { id: "c33", l: "義　女", m: "l" }
    ];

    // 初始化生成欄位
    const fContainer = document.getElementById('fields');
    fMap.forEach(f => {
        const div = document.createElement('div');
        div.className = `i-row ${f.m === 's' ? 's-mode' : 'l-mode'}`;
        div.innerHTML = `<label>${f.l}</label><input type="text" id="${f.id}" oninput="up()">`;
        fContainer.appendChild(div);
    });

    function chMode(m) {
        document.querySelectorAll('.m-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        const rows = document.querySelectorAll('.i-row');
        rows.forEach(r => {
            if (m === 's') {
                r.style.display = r.classList.contains('s-mode') ? 'block' : 'none';
            } else {
                r.style.display = 'block';
            }
        });
        up();
    }

    function up() {
        document.getElementById('out_main').innerText = "故者：" + document.getElementById('in_main').value;
        let html = "";
        fMap.forEach(f => {
            const val = document.getElementById(f.id).value.trim();
            if (val) {
                html += `<div class="r-row">
                    <div class="r-label">${f.l}</div>
                    <div class="r-names">${val.replace(/[,，]/g, "　")}</div>
                </div>`;
            }
        });
        document.getElementById('out_list').innerHTML = html;
    }

    async function gen() {
        const node = document.getElementById('obit-canvas');
        // 先暫時解除縮放以獲得高解析度圖片
        node.style.transform = "scale(1)";
        const canvas = await html2canvas(node, { scale: 3, backgroundColor: "#ffffff" });
        node.style.transform = "scale(0.9)";
        
        document.getElementById('res-img').src = canvas.toDataURL("image/png");
        document.getElementById('pop-img').style.display = 'flex';
    }

    chMode('s'); // 初始設為小家族
</script>

</body>
</html>
